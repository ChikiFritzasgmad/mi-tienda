<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-NDG1TN8LS4"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-NDG1TN8LS4');
    </script>

    <link rel="icon" type="image/webp" href="imagenes/logo.webp">

    <title>Papajose SPA | Comercializadora</title>
    <meta name="description" content="Comercializadora de art√≠culos variados. Env√≠os a todo Chile. Compra segura y trato directo.">
    
    <meta property="og:title" content="Papajose SPA | Cat√°logo Online">
    <meta property="og:description" content="Encuentra de todo a los mejores precios. Stock actualizado.">
    <meta property="og:image" content="imagenes/logo.webp"> 
    <meta property="og:url" content="https://comercializadora.papajose.cl">
    <meta property="og:type" content="website">

    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "Store",
        "name": "Papajose SPA",
        "description": "Comercializadora de art√≠culos variados. Env√≠os a todo Chile.",
        "url": "https://comercializadora.papajose.cl",
        "telephone": "+56936416743",
        "address": {
            "@type": "PostalAddress",
            "addressCountry": "CL"
        },
        "priceRange": "$$",
        "image": "imagenes/logo.webp"
    }
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/brands.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        /* --- ESTILOS VISUALES ORIGINALES --- */
        :root { 
            --beige: #D2B48C; 
            --soft-bg: #FAFAF9; 
            --dark-text: #1a1a1a; 
            --pastel-menu: #FFFBF2; 
        }
        
        body { 
            font-family: 'Segoe UI', sans-serif; 
            color: var(--dark-text);
            background-color: #f0f0f0;
            background-image: url('imagenes/fondo.webp');
            background-size: cover;
            background-position: center;
        }

        /* BLOQUEO DE SCROLL DEL FONDO */
        body.locked {
            overflow: hidden !important;
            height: 100vh;
        }

        /* OPTIMIZACI√ìN DESKTOP */
        @media (min-width: 1024px) {
            body { background-attachment: fixed; } 
            .layout-desktop { margin-left: 280px; } 
            .header-desktop-adjust { padding-left: 280px; }
            .destacados-grid-pc { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
        }
        
        /* OPTIMIZACI√ìN M√ìVIL */
        @media (max-width: 1023px) {
            body { background-attachment: scroll; } 
            
            .mobile-slider { 
                display: flex; overflow-x: auto; scroll-snap-type: x mandatory; gap: 1rem; padding-bottom: 1rem; scrollbar-width: none; 
                -webkit-overflow-scrolling: touch;
            }
            .mobile-slider::-webkit-scrollbar { display: none; }
            
            .slider-card { 
                flex: 0 0 85%; 
                scroll-snap-align: center;
                transform: translateZ(0); will-change: transform; 
            }
            
            body { padding-bottom: 120px; } 
            
            .sticky-search-container {
                position: sticky; top: 80px; z-index: 40;
                background-color: rgba(255, 255, 255, 0.98);
                padding: 10px 16px 15px 16px; margin-left: -16px; margin-right: -16px; margin-bottom: 20px;
                border-bottom: 1px solid #f3f4f6; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            }

            input, select, textarea { font-size: 16px !important; }
            button, a { touch-action: manipulation; }
        }

        .glass-panel {
            background-color: rgba(255, 255, 255, 0.92);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255,255,255,0.5);
        }

        .menu-bg-color { background-color: var(--pastel-menu); }

        .fade-in-up { animation: fadeInUp 0.5s ease-out forwards; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        .no-stock { filter: grayscale(100%); opacity: 0.7; }
        
        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
        
        .toast-enter { transform: translate(-50%, 100%); opacity: 0; }
        .toast-visible { transform: translate(-50%, 0); opacity: 1; }

        .overlay-base {
            position: fixed; inset: 0; background-color: rgba(0,0,0,0.5); backdrop-filter: blur(2px);
            opacity: 0; visibility: hidden; transition: opacity 0.3s ease;
        }
        .overlay-base.open { opacity: 1; visibility: visible; }
        
        #menu-overlay { z-index: 145; } 
        #cart-overlay { z-index: 155; } 

        #cart-sidebar, #left-sidebar { will-change: transform; transition: transform 0.3s cubic-bezier(0.25, 1, 0.5, 1); }
        #mobile-sticky-bar { transition: transform 0.3s ease; }

        /* Modal Desktop */
        @media (min-width: 768px) {
            .product-modal-desktop {
                max-width: 800px;
                max-height: 85vh;
                margin: 5vh auto;
                border-radius: 24px;
                overflow: hidden;
                box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            }
        }

        html { scroll-behavior: smooth; }

        .img-placeholder {
            background: linear-gradient(45deg, #f0f0f0 25%, #e0e0e0 25%, #e0e0e0 50%, #f0f0f0 50%, #f0f0f0 75%, #e0e0e0 75%);
            background-size: 20px 20px;
        }

        .modal-body-scroll {
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain; 
        }
    </style>
</head>
<body class="font-sans antialiased overflow-x-hidden">

    <header class="fixed top-0 w-full bg-white z-[50] border-b border-gray-50 h-20 shadow-sm transition-all duration-300 header-desktop-adjust">
        <div class="h-full flex justify-between items-center px-6 md:px-10 relative">
            <div class="flex items-center z-20">
                <button onclick="toggleMobileMenu()" 
                        aria-label="Abrir men√∫"
                        class="lg:hidden text-2xl text-beige hover:text-black transition"><i class="fa fa-bars"></i></button>
            </div>
            
            <div class="absolute left-1/2 top-1/2 transform -translate-x-1/2 -translate-y-1/2 text-center w-full pointer-events-none z-30">
                <div onclick="resetAndScrollToTop()" class="pointer-events-auto inline-flex items-center gap-3 bg-white/90 backdrop-blur-sm px-4 py-1.5 rounded-full border border-gray-50 shadow-sm cursor-pointer hover:bg-gray-50 transition-all active:scale-95">
                    <img src="imagenes/logo.webp" class="w-8 h-8 rounded-full object-cover bg-white shadow-sm" alt="Logo" onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 32 32%22%3E%3Ccircle cx=%2216%22 cy=%2216%22 r=%2216%22 fill=%22%23D2B48C%22/%3E%3Ctext x=%2216%22 y=%2216%22 font-family=%22Arial%22 font-size=%2210%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22white%22%3EPJ%3C/text%3E%3C/svg%3E'">
                    <h1 class="text-lg md:text-2xl font-black tracking-widest text-gray-800 uppercase whitespace-nowrap">Papajose <span class="text-beige">SPA</span></h1>
                </div>
            </div>

            <div class="flex items-center gap-6 z-20 bg-white pl-4">
                <div class="hidden lg:block relative group">
                    <input type="text" onkeyup="buscar(this.value)" placeholder="Buscar producto o SKU..." class="bg-gray-50/50 border border-transparent rounded-full px-5 py-2.5 w-64 text-sm focus:ring-1 focus:ring-beige focus:bg-white focus:border-beige transition-all">
                    <i class="fa fa-search absolute right-4 top-3 text-beige"></i>
                </div>
                
                <div class="flex items-center gap-3">
                    <button onclick="openAuthModal()" class="relative p-2 group" id="user-btn-header">
                        <i class="fa fa-user text-xl text-gray-400 group-hover:text-black transition" id="user-icon"></i>
                    </button>

                    <span id="header-total" class="hidden md:block font-bold text-gray-700 text-sm opacity-0 transition-opacity duration-300">$0</span>
                    <button onclick="toggleCart()" class="relative p-2 group" id="cart-btn-header">
                        <i class="fa fa-shopping-bag text-2xl text-gray-400 group-hover:text-black transition" id="cart-icon"></i>
                        <span id="cart-badge" class="absolute -top-1 -right-1 bg-black text-white text-[10px] font-bold h-5 w-5 flex items-center justify-center rounded-full border-2 border-white scale-0 transition-transform duration-300">0</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div id="menu-overlay" class="overlay-base" onclick="handleBackAction()"></div>
    <div id="cart-overlay" class="overlay-base" onclick="forceCloseCart()"></div>

    <div id="auth-modal" class="fixed inset-0 z-[200] bg-black bg-opacity-50 hidden items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-3xl shadow-2xl relative flex flex-col max-h-[90vh] overflow-hidden">
            <button onclick="closeAuthModal()" class="absolute top-4 right-4 z-50 bg-gray-100 w-8 h-8 rounded-full flex items-center justify-center text-gray-600 hover:bg-gray-200 transition">‚úï</button>
            <div class="p-8 overflow-y-auto modal-body-scroll">
                
                <div id="auth-login-view">
                    <h2 class="text-2xl font-black text-gray-900 mb-6 tracking-tight">Iniciar Sesi√≥n</h2>
                    <form id="login-form" onsubmit="iniciarSesion(event)" class="space-y-4">
                        <input type="email" id="login-email" placeholder="Correo electr√≥nico" required class="w-full p-4 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-beige outline-none transition text-sm">
                        <input type="password" id="login-pass" placeholder="Contrase√±a" required class="w-full p-4 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-beige outline-none transition text-sm">
                        <button type="submit" id="btn-login-submit" class="w-full bg-black text-white py-4 rounded-xl font-bold uppercase tracking-widest hover:bg-beige transition shadow-lg mt-2 text-sm">Ingresar</button>
                    </form>
                    <p class="text-center text-sm text-gray-500 mt-6">¬øEres nuevo? <span onclick="toggleAuthView()" class="text-beige font-black hover:underline cursor-pointer">Reg√≠strate aqu√≠</span></p>
                </div>

                <div id="auth-register-view" class="hidden">
                    <h2 class="text-2xl font-black text-gray-900 mb-2 tracking-tight">Crear Cuenta</h2>
                    <p class="text-xs text-gray-500 mb-6 uppercase font-bold tracking-widest text-beige">Datos para el repartidor üöö</p>
                    <form id="register-form" onsubmit="registrarUsuario(event)" class="space-y-3">
                        <input type="text" id="reg-nombre" placeholder="Nombre Completo" required class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl text-sm outline-none">
                        <input type="text" id="reg-rut" placeholder="RUT (Ej: 12345678-9)" required class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl text-sm outline-none">
                        <input type="text" id="reg-direccion" placeholder="Direcci√≥n (Calle, N¬∞, Comuna)" required class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl text-sm outline-none">
                        <input type="text" id="reg-referencia" placeholder="Referencia (Ej: Casa port√≥n verde)" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl text-sm outline-none">
                        <input type="email" id="reg-email" placeholder="Correo electr√≥nico" required class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl text-sm outline-none">
                        <input type="email" id="reg-email-confirm" placeholder="Repite tu correo" required class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl text-sm outline-none">
                        <input type="password" id="reg-pass" placeholder="Crea una clave (m√≠n 6 caracteres)" required minlength="6" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl text-sm outline-none">
                        <button type="submit" id="btn-reg-submit" class="w-full bg-black text-white py-4 rounded-xl font-bold uppercase tracking-widest hover:bg-beige transition shadow-lg mt-2 text-sm">Crear mi cuenta</button>
                    </form>
                    <p class="text-center text-sm text-gray-500 mt-6">¬øYa tienes cuenta? <span onclick="toggleAuthView()" class="text-beige font-black hover:underline cursor-pointer">Inicia Sesi√≥n</span></p>
                </div>

                <div id="auth-logged-view" class="hidden">
                    <h2 class="text-xl font-black text-gray-900 mb-2">Mis Datos de Env√≠o</h2>
                    <p class="text-xs text-gray-500 mb-6" id="logged-user-email"></p>
                    <form id="edit-profile-form" onsubmit="actualizarPerfil(event)" class="space-y-3">
                        <div><label class="text-[10px] font-bold text-gray-400 uppercase ml-2">Nombre Completo</label><input type="text" id="edit-nombre" required class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl text-sm outline-none"></div>
                        <div><label class="text-[10px] font-bold text-gray-400 uppercase ml-2">RUT</label><input type="text" id="edit-rut" required class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl text-sm outline-none"></div>
                        <div><label class="text-[10px] font-bold text-gray-400 uppercase ml-2">Direcci√≥n de Entrega</label><input type="text" id="edit-direccion" required class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl text-sm outline-none"></div>
                        <div><label class="text-[10px] font-bold text-gray-400 uppercase ml-2">Referencia</label><input type="text" id="edit-referencia" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl text-sm outline-none"></div>
                        <button type="submit" id="btn-update-profile" class="w-full bg-beige text-white py-3 rounded-xl font-bold uppercase text-xs shadow-md mt-2">Actualizar mis datos</button>
                    </form>
                    <button onclick="cerrarSesion()" class="w-full mt-8 text-red-400 text-xs font-bold uppercase hover:underline">Cerrar Sesi√≥n</button>
                </div>
            </div>
        </div>
    </div>

    <aside id="left-sidebar" class="fixed inset-y-0 left-0 w-[280px] menu-bg-color border-r border-gray-100 z-[150] pt-24 transform -translate-x-full lg:translate-x-0 shadow-2xl flex flex-col justify-between h-full">
        <div class="p-6 overflow-y-auto">
            <div class="flex justify-between items-center mb-8 lg:hidden">
                <span class="font-bold text-gray-400 uppercase tracking-widest text-xs">Navegaci√≥n</span>
                <button onclick="handleBackAction()" class="text-2xl text-gray-500">‚úï</button>
            </div>
            <button onclick="openAuthModal(); toggleMobileMenu();" class="w-full text-left px-5 py-4 rounded-xl bg-black text-white font-bold flex items-center gap-3 transition-all mb-6 lg:hidden shadow-md">
                <i class="fa fa-user-circle text-lg"></i> <span id="mobile-menu-user-txt">Mi Cuenta</span>
            </button>
            <nav class="space-y-2" id="nav-categorias"></nav>
        </div>
        <div class="p-8 border-t border-gray-100 bg-white/50">
            <h4 class="text-xs font-black uppercase text-gray-400 mb-4 tracking-widest">S√≠guenos</h4>
            <div class="flex gap-6 text-2xl text-gray-400">
                <a href="https://www.instagram.com/comercializadora_papa_jose_spa" target="_blank" class="hover:text-beige transition hover:-translate-y-1"><i class="fab fa-instagram"></i></a>
                <a href="https://www.tiktok.com/@papa_jose_spa" target="_blank" class="hover:text-beige transition hover:-translate-y-1"><i class="fab fa-tiktok"></i></a>
                <a href="https://wa.me/56936416743" target="_blank" class="hover:text-beige transition hover:-translate-y-1"><i class="fab fa-whatsapp"></i></a>
            </div>
            <p class="text-[10px] text-gray-300 mt-4">¬© 2026 Papajose SPA</p>
        </div>
    </aside>

    <main id="main-content" class="pt-28 px-4 md:px-12 layout-desktop min-h-screen">
        
        <div class="lg:hidden sticky-search-container">
            <div class="relative w-full">
                <input type="text" onkeyup="buscar(this.value)" placeholder="Buscar por nombre o SKU..." class="w-full bg-gray-50 border border-transparent p-4 pl-12 rounded-2xl shadow-sm focus:ring-1 focus:ring-beige focus:bg-white transition">
                <i class="fa fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-beige"></i>
            </div>
        </div>

        <section id="hero-section" class="relative glass-panel text-gray-800 py-12 px-6 md:px-12 mb-12 rounded-[2rem] overflow-hidden shadow-lg fade-in-up hidden">
            <div class="relative z-10 max-w-6xl mx-auto">
                <div class="text-center mb-8">
                    <span class="inline-block py-1.5 px-4 rounded-full bg-black text-white font-bold text-[10px] md:text-xs tracking-widest uppercase mb-4 shadow-sm">Comercializadora Online</span>
                    <h2 class="text-3xl md:text-5xl font-black mb-4 leading-tight text-gray-900 tracking-tight">
                        Variedad, Calidad y <span class="text-beige italic font-serif">Buenos Precios.</span>
                    </h2>
                </div>

                <div class="mt-8 border-t border-gray-200 pt-8">
                    <h3 class="text-center font-bold text-gray-400 text-xs uppercase tracking-widest mb-6">üî• Ofertas Destacadas</h3>
                    <div id="hero-destacados-container" class="mobile-slider destacados-grid-pc pb-2">
                        </div>
                </div>
            </div>
        </section>

        <section class="mb-16 py-10 px-4 bg-white/95 border-2 border-gray-100 rounded-3xl shadow-md">
            <h3 class="text-center font-black text-gray-900 text-sm uppercase tracking-widest mb-10 border-b pb-4 border-gray-200">
                <i class="fa fa-check-circle text-green-500 mr-2"></i> Proceso de Compra Seguro
            </h3>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-8 text-center">
                <div class="flex flex-col items-center group">
                    <div class="w-14 h-14 bg-black text-white rounded-2xl flex items-center justify-center text-xl mb-4 shadow-lg"><i class="fa fa-hand-pointer"></i></div>
                    <span class="font-black text-gray-900 text-base">1. Elige</span>
                    <p class="text-xs font-bold text-gray-500 mt-2 px-2 leading-tight">Selecciona tus productos</p>
                </div>
                <div class="flex flex-col items-center group">
                    <div class="w-14 h-14 bg-black text-white rounded-2xl flex items-center justify-center text-xl mb-4 shadow-lg"><i class="fa fa-whatsapp"></i></div>
                    <span class="font-black text-gray-900 text-base">2. Valida</span>
                    <p class="text-xs font-bold text-gray-500 mt-2 px-2 leading-tight">Confirma stock v√≠a WhatsApp</p>
                </div>
                <div class="flex flex-col items-center group">
                    <div class="w-14 h-14 bg-black text-white rounded-2xl flex items-center justify-center text-xl mb-4 shadow-lg"><i class="fa fa-building-columns"></i></div>
                    <span class="font-black text-gray-900 text-base">3. Paga</span>
                    <p class="text-xs font-bold text-gray-500 mt-2 px-2 leading-tight">A <strong>Cuenta Empresa</strong></p>
                </div>
                <div class="flex flex-col items-center group">
                    <div class="w-14 h-14 bg-black text-white rounded-2xl flex items-center justify-center text-xl mb-4 shadow-lg"><i class="fa fa-box"></i></div>
                    <span class="font-black text-gray-900 text-base">4. Recibe</span>
                    <p class="text-xs font-bold text-gray-500 mt-2 px-2 leading-tight">Env√≠os a todo Chile</p>
                </div>
            </div>
        </section>

        <div id="loading-msg" class="text-center py-20 glass-panel rounded-2xl mb-10">
            <i class="fa fa-circle-notch fa-spin text-4xl text-beige mb-4"></i>
            <p class="text-gray-900 font-bold">Cargando inventario actualizado...</p>
        </div>

        <section id="seccion-catalogo" class="hidden mb-12">
            <div class="glass-panel p-6 rounded-2xl mb-6 flex items-center justify-between shadow-sm">
                <h2 id="titulo-grid" class="text-xl font-black text-gray-900 uppercase tracking-widest">Cat√°logo</h2>
                <span id="cantidad-productos" class="text-xs font-bold text-white bg-black px-3 py-1.5 rounded-lg">0</span>
            </div>
            
            <div id="grid-productos" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 md:gap-8 mb-8"></div>
            
            <div id="pagination-controls" class="flex justify-center items-center gap-4 py-6 hidden">
                <button onclick="changePage(-1)" id="btn-prev" class="bg-white px-4 py-2 rounded-full shadow font-bold text-sm border">Anterior</button>
                <span id="page-indicator" class="font-bold text-gray-900 bg-white px-4 py-2 rounded-full shadow border">P√°g 1</span>
                <button onclick="changePage(1)" id="btn-next" class="bg-black text-white px-6 py-2 rounded-full shadow font-bold text-sm disabled:opacity-50">Siguiente</button>
            </div>
        </section>

        <section class="max-w-3xl mx-auto mb-20 space-y-4">
            
            <details class="group glass-panel rounded-2xl p-6 cursor-pointer open:ring-1 open:ring-beige/30 transition-all shadow-sm">
                <summary class="flex justify-between items-center font-bold text-gray-900 list-none select-none">
                    <div class="flex items-center gap-3"><i class="fa fa-user-tag text-beige text-xl"></i><span class="uppercase tracking-wider text-sm">Qui√©nes Somos</span></div>
                    <span class="text-gray-400 group-open:rotate-180 transition-transform duration-300"><i class="fa fa-chevron-down"></i></span>
                </summary>
                <div class="mt-6 text-gray-800 text-sm md:text-base leading-relaxed border-t border-gray-200 pt-4 font-medium">
                    <p><strong>Papajose SPA</strong> naci√≥ hace un a√±o como una iniciativa digital enfocada en el servicio. Tras miles de ventas exitosas en plataformas como Mercado Libre y un aprendizaje constante sobre lo que nuestros clientes realmente necesitan, decidimos dar <strong>el gran salto</strong>.</p>
                    <p class="mt-2">Hoy evolucionamos con nuestra propia plataforma para ofrecerte un <strong>trato directo, sin comisiones ocultas y precios realmente justos</strong>.</p>
                </div>
            </details>

            <details class="group glass-panel rounded-2xl p-6 cursor-pointer open:ring-1 open:ring-beige/30 transition-all shadow-sm">
                <summary class="flex justify-between items-center font-bold text-gray-900 list-none select-none">
                    <div class="flex items-center gap-3"><i class="fa fa-shield-alt text-beige text-xl"></i><span class="uppercase tracking-wider text-sm">Confianza y Pagos</span></div>
                    <span class="text-gray-400 group-open:rotate-180 transition-transform duration-300"><i class="fa fa-chevron-down"></i></span>
                </summary>
                <div class="mt-6 text-gray-800 text-sm md:text-base leading-relaxed border-t border-gray-200 pt-4 font-medium">
                    <p>ü§ù <strong>Sin intermediarios:</strong> Pago directo a Cuenta Empresa.</p>
                    <p>üìÑ <strong>Documentaci√≥n:</strong> Boleta o Factura en 24 horas.</p>
                </div>
            </details>

            <details class="group glass-panel rounded-2xl p-6 cursor-pointer open:ring-1 open:ring-beige/30 transition-all shadow-sm">
                <summary class="flex justify-between items-center font-bold text-gray-900 list-none select-none">
                    <div class="flex items-center gap-3"><i class="fa fa-rotate-left text-beige text-xl"></i><span class="uppercase tracking-wider text-sm">Garant√≠a</span></div>
                    <span class="text-gray-400 group-open:rotate-180 transition-transform duration-300"><i class="fa fa-chevron-down"></i></span>
                </summary>
                <div class="mt-6 text-gray-800 text-sm md:text-base leading-relaxed border-t border-gray-200 pt-4 font-medium">
                    <p>‚úÖ <strong>Garant√≠a Real:</strong> Cambios y devoluciones sin costo si el producto falla.</p>
                </div>
            </details>

        </section>

    </main>

    <aside id="cart-sidebar" class="fixed inset-y-0 right-0 w-full md:w-[420px] bg-white z-[160] shadow-2xl transform translate-x-full flex flex-col h-full">
        <div class="p-6 border-b border-gray-50 flex justify-between items-center bg-gray-50/50 flex-shrink-0">
            <h2 class="text-xl font-black uppercase text-gray-800">Tu Carrito</h2>
            <button onclick="forceCloseCart()" class="text-gray-400 hover:text-black transition text-xl w-10 h-10 rounded-full hover:bg-white flex items-center justify-center">‚úï</button>
        </div>
        
        <div id="cart-items" class="flex-1 overflow-y-auto p-6 space-y-6"></div>
        
        <div class="p-5 bg-white border-t border-gray-50 shadow-[0_-5px_20px_rgba(0,0,0,0.05)] flex-shrink-0">
            <div class="mb-4 flex gap-4 text-xs">
                <div class="flex-1">
                      <h4 class="font-bold text-[10px] uppercase text-gray-400 mb-2 tracking-wider">Env√≠o (Obligatorio)</h4>
                      <label class="flex items-center gap-2 cursor-pointer p-2 border border-gray-100 rounded-lg hover:border-beige transition bg-gray-50 mb-2">
                        <input type="radio" name="tipo_envio" value="rm" checked onchange="calcularTotal()" class="accent-black w-3 h-3">
                        <div><span class="block font-bold text-gray-700 text-[11px]">RM</span><span class="text-[10px] text-gray-500">+$3.500</span></div>
                      </label>
                      <label class="flex items-center gap-2 cursor-pointer p-2 border border-gray-100 rounded-lg hover:border-beige transition bg-gray-50">
                        <input type="radio" name="tipo_envio" value="regiones" onchange="calcularTotal()" class="accent-black w-3 h-3">
                        <div><span class="block font-bold text-gray-700 text-[11px]">Regiones</span><span class="text-[10px] text-gray-500">Por pagar (Starken)</span></div>
                      </label>
                </div>
                <div class="flex-1">
                    <h4 class="font-bold text-[10px] uppercase text-gray-400 mb-2 tracking-wider">Doc.</h4>
                    <label class="flex items-center gap-2 cursor-pointer p-2 border border-gray-100 rounded-lg hover:border-beige transition bg-gray-50 mb-2">
                        <input type="radio" name="tipo_doc" value="Boleta" checked class="accent-black w-3 h-3">
                        <span class="font-bold text-gray-700 text-[11px]">Boleta</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer p-2 border border-gray-100 rounded-lg hover:border-beige transition bg-gray-50">
                        <input type="radio" name="tipo_doc" value="Factura" class="accent-black w-3 h-3">
                        <span class="font-bold text-gray-700 text-[11px]">Factura</span>
                    </label>
                </div>
            </div>

            <div class="flex justify-between text-2xl font-black text-gray-900 mb-4">
                <span>Total Final</span> 
                <span id="cart-total">$0</span>
            </div>
            <button id="btn-checkout" onclick="procesarCheckout()" class="w-full bg-black text-white py-4 rounded-xl font-bold uppercase tracking-widest hover:bg-beige transition-all shadow-lg flex items-center justify-center gap-3 text-sm">
                Ir a Pagar <i class="fab fa-whatsapp text-lg"></i>
            </button>
        </div>
    </aside>

    <div id="mobile-sticky-bar" onclick="toggleCart()" class="fixed bottom-0 left-0 w-full bg-white/95 backdrop-blur-md border-t border-gray-200 p-4 z-[60] shadow-lg flex justify-between items-center lg:hidden hidden fade-in-up cursor-pointer">
        <div class="flex flex-col pointer-events-none">
            <span class="text-[10px] text-gray-400 font-bold uppercase tracking-wider">Total Productos</span>
            <span id="mobile-total-sticky" class="text-xl font-black text-gray-900">$0</span>
        </div>
        <button class="bg-black text-white px-6 py-3 rounded-xl font-bold text-sm shadow-xl">Ver Carrito <i class="fa fa-shopping-cart"></i></button>
    </div>

    <button id="desktop-floating-cart" onclick="toggleCart()" class="hidden lg:flex fixed bottom-8 right-8 bg-black text-white px-6 py-3 rounded-full font-bold shadow-2xl z-[55] hover:scale-105 transition-transform items-center gap-3 border-2 border-white hover:bg-beige">
        <i class="fa fa-shopping-bag"></i>
        <span id="desktop-floating-total">$0</span>
    </button>

    <div id="product-modal" onclick="if(event.target === this) closeProductModal()" class="fixed inset-0 z-[200] bg-black bg-opacity-50 hidden items-center justify-center p-4">
        <div class="bg-white product-modal-desktop w-full max-w-4xl max-h-[85vh] flex flex-col rounded-2xl shadow-2xl relative h-full">
            <button onclick="closeProductModal()" class="absolute top-4 right-4 z-50 bg-white w-10 h-10 rounded-full flex items-center justify-center shadow-lg text-lg hover:bg-red-100 hover:text-red-500 transition">‚úï</button>
            <div id="modal-content" class="flex-1 flex flex-col overflow-hidden relative h-full"></div>
        </div>
    </div>
    
    <div id="toast-modal" class="fixed bottom-24 left-1/2 transform -translate-x-1/2 z-[200] hidden transition-all w-11/12 max-w-sm toast-enter">
        <div class="bg-gray-900 text-white rounded-2xl p-4 shadow-2xl flex items-center justify-between gap-4">
            <div class="flex items-center gap-3" id="toast-content"></div>
        </div>
    </div>

<script>
    // --- CONFIGURACI√ìN GLOBAL Y SUPABASE ---
    const WHATSAPP_NUM = "56936416743"; 
    const supabaseUrl = 'https://elwzheytotfsxzrcsioz.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVsd3poZXl0b3Rmc3h6cmNzaW96Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzExNzE0MzIsImV4cCI6MjA4Njc0NzQzMn0.0WLFkRsWPdYJSL_Oo6TtK0t5P_0cv9pJi95uXm9TKTg';
    const supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);
    
    let db = [];
    let cart = JSON.parse(localStorage.getItem('papajose_cart')) || [];
    let currentFilteredList = []; 
    let currentPage = 1;
    const itemsPerPage = 20; 
    
    let hasOpenedCartAutomatically = false; 
    let searchTimeout; 
    let costoEnvio = 3500; 
    let totalPagarFinal = 0;
    
    // ESTADO DE USUARIO
    let currentUser = null;
    let userProfile = null;

    const PLACEHOLDER_SVG = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 400 400'%3E%3Crect width='400' height='400' fill='%23f0f0f0'/%3E%3Ctext x='50%25' y='50%25' font-family='Arial' font-size='14' text-anchor='middle' dy='.3em' fill='%23999'%3ESin Foto%3C/text%3E%3C/svg%3E";

    // --- NAVEGACI√ìN Y EVENTOS INICIALES ---
    window.addEventListener('popstate', function(event) {
        const modal = document.getElementById('product-modal');
        const authModal = document.getElementById('auth-modal');
        const cartSidebar = document.getElementById('cart-sidebar');
        const leftSidebar = document.getElementById('left-sidebar');
        const stickyBar = document.getElementById('mobile-sticky-bar');

        if (!modal.classList.contains('hidden')) {
            modal.classList.add('hidden');
            document.body.classList.remove('locked');
        }
        if (!authModal.classList.contains('hidden')) {
            closeAuthModal();
        }
        if (cartSidebar.classList.contains('translate-x-0')) {
            forceCloseCart(); 
        }
        if (!leftSidebar.classList.contains('-translate-x-full')) {
            leftSidebar.classList.add('-translate-x-full');
            document.getElementById('menu-overlay').classList.remove('open');
            document.body.classList.remove('locked');
            if(cart.length > 0 && window.innerWidth < 1024) stickyBar.classList.remove('translate-y-full');
        }
    });

    window.addEventListener('DOMContentLoaded', () => { 
        verificarSesion();
        cargarBaseDatos(); 
        updateCartUI();
        initSwipeGestures();
    });

    function resetAndScrollToTop() {
        window.scrollTo({ top: 0, behavior: 'smooth' });
        const btnTodas = document.getElementById('btn-todas');
        if(btnTodas) {
            filtrar('todas', btnTodas);
        } else {
            // Si el men√∫ no est√° listo, simplemente mostramos todo
            currentFilteredList = db;
            currentPage = 1;
            renderGrid(currentFilteredList);
        }
        document.querySelectorAll('input[type="text"]').forEach(input => input.value = '');
        mostrarToast("Volviendo al inicio", "info");
    }

    // --- SISTEMA DE USUARIOS Y AUTENTICACI√ìN ---
    async function verificarSesion() {
        const { data: { session } } = await supabaseClient.auth.getSession();
        if (session) {
            currentUser = session.user;
            await cargarPerfil(currentUser.id);
        }
        actualizarBotonesUsuario();
        
        // Escuchar cambios de sesi√≥n (cuando inicia o cierra sesi√≥n)
        supabaseClient.auth.onAuthStateChange(async (event, session) => {
            if (session) {
                currentUser = session.user;
                await cargarPerfil(currentUser.id);
            } else {
                currentUser = null;
                userProfile = null;
            }
            actualizarBotonesUsuario();
        });
    }

    async function cargarPerfil(userId) {
        const { data, error } = await supabaseClient
            .from('profiles')
            .select('*')
            .eq('id', userId)
            .maybeSingle(); // Cambiado de single() a maybeSingle() para evitar error si no existe
        if (!error && data) { 
            userProfile = data; 
        } else {
            userProfile = null;
        }
        return userProfile; // Devolvemos para poder esperarlo
    }

    function actualizarBotonesUsuario() {
        const icon = document.getElementById('user-icon');
        const mobileTxt = document.getElementById('mobile-menu-user-txt');
        if (currentUser) {
            icon.classList.replace('fa-user', 'fa-user-check');
            icon.classList.replace('text-gray-400', 'text-beige');
            if(mobileTxt) mobileTxt.innerText = "Mi Perfil";
        } else {
            icon.classList.replace('fa-user-check', 'fa-user');
            icon.classList.replace('text-beige', 'text-gray-400');
            if(mobileTxt) mobileTxt.innerText = "Mi Cuenta";
        }
    }

    function openAuthModal() {
        history.pushState({modal: 'auth'}, null, "");
        const modal = document.getElementById('auth-modal');
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        document.body.classList.add('locked');
        
        if (currentUser && userProfile) {
            // Usuario ya inici√≥ sesi√≥n: mostrar vista de Perfil
            document.getElementById('auth-login-view').classList.add('hidden');
            document.getElementById('auth-register-view').classList.add('hidden');
            document.getElementById('auth-logged-view').classList.remove('hidden');
            document.getElementById('logged-user-name').innerText = "Hola, " + (userProfile.nombre?.split(' ')[0] || 'Cliente');
            document.getElementById('logged-user-email').innerText = currentUser.email;
        } else {
            // Usuario no ha iniciado sesi√≥n: mostrar vista de Login por defecto
            document.getElementById('auth-logged-view').classList.add('hidden');
            document.getElementById('auth-register-view').classList.add('hidden');
            document.getElementById('auth-login-view').classList.remove('hidden');
        }
    }

    function closeAuthModal() {
        const modal = document.getElementById('auth-modal');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        document.body.classList.remove('locked');
        if(history.state && history.state.modal === 'auth') history.back();
    }

    function toggleAuthView() {
        const login = document.getElementById('auth-login-view');
        const reg = document.getElementById('auth-register-view');
        if(login.classList.contains('hidden')) {
            login.classList.remove('hidden'); 
            reg.classList.add('hidden');
        } else {
            login.classList.add('hidden'); 
            reg.classList.remove('hidden');
        }
    }

    async function registrarUsuario(e) {
        e.preventDefault();
        
        const email = document.getElementById('reg-email').value;
        const emailConfirm = document.getElementById('reg-email-confirm').value;

        if(email !== emailConfirm) {
            mostrarToast("Los correos no coinciden. Rev√≠salos.", "error");
            return;
        }

        const btn = document.getElementById('btn-reg-submit');
        btn.innerText = "Creando cuenta..."; 
        btn.disabled = true;

        const pass = document.getElementById('reg-pass').value;
        const nombre = document.getElementById('reg-nombre').value;
        const rut = document.getElementById('reg-rut').value;
        const direccion = document.getElementById('reg-direccion').value;
        const referencia = document.getElementById('reg-referencia').value;

        try {
            // 1. Crear usuario en Auth de Supabase
            const { data: authData, error: authErr } = await supabaseClient.auth.signUp({ 
                email: email, 
                password: pass 
            });
            if (authErr) throw authErr;

            // 2. Guardar datos en la tabla Perfiles
            if (authData.user) {
                const { error: profileErr } = await supabaseClient.from('profiles').insert({
                    id: authData.user.id,
                    nombre: nombre,
                    rut: rut,
                    direccion_defecto: direccion,
                    referencia: referencia
                });
                if (profileErr) throw profileErr;
            }

            mostrarToast("¬°Cuenta creada con √©xito!");
            closeAuthModal();
        } catch (error) {
            console.error(error);
            mostrarToast("Error: " + (error.message || "No se pudo crear"), "error");
        } finally {
            btn.innerText = "Crear mi cuenta"; 
            btn.disabled = false;
        }
    }
    
    async function iniciarSesion(e) {
        e.preventDefault();
        const btn = document.getElementById('btn-login-submit');
        btn.innerText = "Ingresando..."; 
        btn.disabled = true;
        
        const email = document.getElementById('login-email').value;
        const pass = document.getElementById('login-pass').value;

        const { data, error } = await supabaseClient.auth.signInWithPassword({ 
            email: email, 
            password: pass 
        });
        
        btn.innerText = "Ingresar"; 
        btn.disabled = false;

        if (error) { 
            mostrarToast("Correo o contrase√±a incorrectos", "error"); 
        } else { 
            mostrarToast("¬°Bienvenido de vuelta!"); 
            closeAuthModal(); 
        }
    }

    async function cerrarSesion() {
        await supabaseClient.auth.signOut();
        mostrarToast("Sesi√≥n cerrada", "info");
        closeAuthModal();
    }

    // --- CARGA DE PRODUCTOS DESDE SUPABASE ---
    async function cargarBaseDatos() {
        try {
            const { data, error } = await supabaseClient
                .from('products')
                .select('*')
                .order('destacado', { ascending: false });

            if (error) throw error;

            db = data.map(p => ({
                id: p.id,
                sku: p.numero_producto || 'S/N',
                nombre: p.producto,
                desc: p.descripcion || 'Sin descripci√≥n',
                cat: p.categoria || 'Otros',
                precio: Number(p.precio) || 0,
                img: p.foto || '',
                disponible: p.estado_stock && p.estado_stock.toLowerCase().includes('con stock'),
                destacado: p.destacado || 0,
                stock: p.stock || 0 // Asumimos que existe columna stock num√©rica
            }));

            procesarBaseDatos();
        } catch (error) {
            console.error("Error cargando productos:", error);
            mostrarToast("Error cargando productos. Intenta recargar.", "error");
            document.getElementById('loading-msg').innerHTML = '<p class="text-red-500 font-bold">Error de conexi√≥n con la Base de Datos.</p>';
        }
    }

    function procesarBaseDatos() {
        document.getElementById('loading-msg').classList.add('hidden');
        document.getElementById('seccion-catalogo').classList.remove('hidden');

        if (db.length === 0) {
            mostrarToast("No hay productos disponibles", "info");
            document.getElementById('grid-productos').innerHTML = '<div class="col-span-full py-10 text-center text-gray-500 bg-white/80 rounded-xl p-6"><p>No se encontraron productos en la base de datos.</p></div>';
            return;
        }
        
        db = db.filter(p => p.nombre && p.nombre !== "Sin Nombre").map(p => {
            let cleanSku = p.sku ? p.sku.toString().replace(/\D/g, '').substring(0, 5) : 'S/N';
            return { ...p, sku: cleanSku };
        });

        generarMenuCategorias();
        
        currentFilteredList = db;
        renderGrid(currentFilteredList);
        renderDestacados(db);
    }

    // --- L√ìGICA DE VISUALIZACI√ìN, PAGINACI√ìN Y FILTROS ---
    function changePage(direction) {
        const totalPages = Math.ceil(currentFilteredList.length / itemsPerPage);
        const newPage = currentPage + direction;
        if (newPage >= 1 && newPage <= totalPages) {
            currentPage = newPage;
            renderGrid(currentFilteredList);
            window.scrollTo({
                top: document.getElementById('seccion-catalogo').getBoundingClientRect().top + window.pageYOffset - 120, 
                behavior: 'smooth'
            });
        }
    }

    function renderPaginationControls() {
        const controls = document.getElementById('pagination-controls');
        const totalPages = Math.ceil(currentFilteredList.length / itemsPerPage);
        if (totalPages <= 1) { 
            controls.classList.add('hidden'); 
            return; 
        }
        controls.classList.remove('hidden');
        document.getElementById('page-indicator').innerText = `P√°g ${currentPage} de ${totalPages}`;
        document.getElementById('btn-prev').disabled = currentPage === 1;
        document.getElementById('btn-next').disabled = currentPage === totalPages;
    }

    function renderGrid(lista) { 
        const contenedor = document.getElementById('grid-productos');
        const cantidad = document.getElementById('cantidad-productos');
        cantidad.innerText = lista.length;
        
        if(lista.length === 0) { 
            contenedor.innerHTML = `<div class="col-span-full py-10 text-center text-gray-500 bg-white/80 rounded-xl p-6"><p>No se encontraron productos.</p></div>`; 
            document.getElementById('pagination-controls').classList.add('hidden');
            return; 
        }
        
        const start = (currentPage - 1) * itemsPerPage;
        const end = start + itemsPerPage;
        contenedor.innerHTML = lista.slice(start, end).map(p => cardHTML(p)).join(''); 
        renderPaginationControls();
    }

    function renderDestacados(lista) {
        const destacados = lista.filter(p => p.destacado === 1 && p.disponible).slice(0, 6); 
        const container = document.getElementById('hero-destacados-container');
        const section = document.getElementById('hero-section');
        
        if (destacados.length === 0) {
            section.classList.add('hidden'); 
            return;
        }
        
        section.classList.remove('hidden'); 
        
        container.innerHTML = destacados.map(p => `
            <div class="slider-card bg-white rounded-2xl border border-gray-200 overflow-hidden relative h-full flex flex-col shadow-sm cursor-pointer hover:shadow-md transition-all" onclick="openProduct(${p.id})">
                <div class="relative h-48 md:h-56 bg-white p-2">
                    <img src="${p.img}" 
                         class="w-full h-full object-contain" 
                         alt="${p.nombre}"
                         loading="lazy"
                         onerror="this.onerror=null; this.src='${PLACEHOLDER_SVG}'; this.classList.add('img-placeholder')">
                    <div class="absolute top-2 left-2 bg-black text-white px-2 py-1 rounded text-[10px] font-bold uppercase shadow-sm">Destacado</div>
                </div>
                <div class="p-3 flex flex-col flex-1">
                    <h3 class="font-bold text-gray-800 text-xs md:text-sm mb-1 line-clamp-2">${p.nombre}</h3>
                    <span class="text-sm md:text-lg font-black text-gray-900 mt-auto">$${p.precio.toLocaleString()}</span>
                </div>
            </div>
        `).join('');
    }

    let lastSearch = '';
    function buscar(query) {
        if (query === lastSearch) return;
        lastSearch = query;
        clearTimeout(searchTimeout); 
        
        if (query.length > 2) {
            document.getElementById('grid-productos').innerHTML = '<div class="col-span-full py-10 text-center"><i class="fa fa-spinner fa-spin text-beige text-2xl mb-2"></i><p class="text-gray-600">Buscando...</p></div>';
        }
        
        searchTimeout = setTimeout(() => {
            const texto = query.toLowerCase();
            currentFilteredList = db.filter(p => 
                p.nombre.toLowerCase().includes(texto) || 
                p.cat.toLowerCase().includes(texto) ||
                p.desc.toLowerCase().includes(texto) ||
                (p.sku && p.sku.toLowerCase().includes(texto))
            );
            currentPage = 1; 
            renderGrid(currentFilteredList);
            if(query.length > 0) {
                const section = document.getElementById('seccion-catalogo');
                window.scrollTo({ top: section.offsetTop - 100, behavior: 'smooth' });
            }
        }, 300); 
    }

    function filtrar(cat, btnElement) {
        if(window.innerWidth < 1024 && !document.getElementById('left-sidebar').classList.contains('-translate-x-full')) {
            toggleMobileMenu();
        }
        document.querySelectorAll('#nav-categorias button').forEach(b => {
            b.className = "w-full text-left px-5 py-3 rounded-xl hover:bg-gray-50 font-medium text-gray-600 flex items-center gap-3 transition-all group";
        });
        if(btnElement) {
            btnElement.className = "w-full text-left px-5 py-3 rounded-xl bg-gray-50 font-bold text-beige flex items-center gap-3 transition-all group border-l-4 border-beige";
        }
        currentFilteredList = cat === 'todas' ? db : db.filter(p => p.cat === cat);
        document.getElementById('titulo-grid').innerText = cat === 'todas' ? 'Cat√°logo Completo' : cat;
        currentPage = 1;
        renderGrid(currentFilteredList);
        window.scrollTo({ top: document.getElementById('seccion-catalogo').getBoundingClientRect().top + window.pageYOffset - 110, behavior: 'smooth' });
    }

    function generarMenuCategorias() {
        const nav = document.getElementById('nav-categorias');
        nav.innerHTML = ''; 
        const btnTodas = document.createElement('button');
        btnTodas.className = "w-full text-left px-5 py-3 rounded-xl bg-gray-50 font-bold text-beige flex items-center gap-3 transition-all group border-l-4 border-beige";
        btnTodas.id = "btn-todas";
        btnTodas.onclick = () => filtrar('todas', btnTodas);
        btnTodas.innerHTML = `<i class="fa fa-border-all text-beige group-hover:scale-110 transition w-5 text-center"></i> Todo`;
        nav.appendChild(btnTodas);
        
        const categoriasManuales = [
            "Hogar",
            "Electr√≥nica y accesorios",
            "Belleza e Higiene",
            "Deportes y Outdoor",
            "Juguetes",
            "Ropa y Accesorios",
            "Vehiculos",
            "Otros"
        ];

        categoriasManuales.forEach(cat => {
            const btn = document.createElement('button');
            btn.className = "w-full text-left px-5 py-3 rounded-xl hover:bg-gray-50 font-medium text-gray-600 flex items-center gap-3 transition-all group";
            btn.onclick = () => filtrar(cat, btn);
            btn.innerHTML = `<i class="fa fa-chevron-right text-gray-300 text-xs group-hover:text-beige transition"></i> ${cat}`;
            nav.appendChild(btn);
        });
    }

    // --- MANEJO DEL CARRITO ---
    function addToCart(id) {
        const p = db.find(x => x.id === id);
        if (!p || !p.disponible) { 
            mostrarToast("Producto agotado", "error"); 
            return; 
        }
        let item = cart.find(i => i.id === id);
        if (item) {
            item.qty++; 
        } else {
            cart.push({ ...p, qty: 1 });
        }
        updateCartUI();
        mostrarToast("¬°Agregado al carrito!");
        
        const badge = document.getElementById('cart-badge');
        badge.classList.add('scale-125');
        setTimeout(() => badge.classList.remove('scale-125'), 200);
        document.getElementById('cart-icon').classList.replace('text-gray-400', 'text-beige');
        
        if (window.innerWidth >= 1024 && !hasOpenedCartAutomatically) {
            if (document.getElementById('cart-sidebar').classList.contains('translate-x-full')) { 
                toggleCart(); 
                hasOpenedCartAutomatically = true; 
            }
        }
    }

    function cambiarCantidad(id, n) {
        let item = cart.find(x => x.id === id);
        if(!item) return;
        item.qty += n;
        if(item.qty <= 0) {
            removeFromCart(id); 
        } else {
            updateCartUI();
        }
    }

    function removeFromCart(id) {
        cart = cart.filter(i => i.id !== id);
        updateCartUI();
        if(cart.length === 0) {
            document.getElementById('cart-icon').classList.replace('text-beige', 'text-gray-400');
            forceCloseCart();
        }
    }

    function toggleCart() {
        const sidebar = document.getElementById('cart-sidebar');
        const overlay = document.getElementById('cart-overlay');
        const stickyBar = document.getElementById('mobile-sticky-bar');
        const isOpen = sidebar.classList.contains('translate-x-0');
        
        if (cart.length === 0 && !isOpen) { 
            mostrarToast("Tu carrito est√° vac√≠o", "info"); 
            return; 
        }
        
        if (!isOpen) { 
            history.pushState({modal: 'cart'}, null, "");
            sidebar.classList.remove('translate-x-full'); 
            sidebar.classList.add('translate-x-0'); 
            overlay.classList.add('open'); 
            document.body.classList.add('locked');
            if(window.innerWidth < 1024) stickyBar.classList.add('hidden');
        } else {
            history.back();
        }
    }
    
    function toggleMobileMenu() { 
        const sidebar = document.getElementById('left-sidebar');
        if (sidebar.classList.contains('-translate-x-full')) { 
            history.pushState({modal: 'menu'}, null, ""); 
            sidebar.classList.remove('-translate-x-full'); 
            document.getElementById('menu-overlay').classList.add('open'); 
            document.body.classList.add('locked');
        } else {
            history.back(); 
        }
    }

    function handleBackAction() { 
        history.back(); 
    }

    function forceCloseCart() {
        const sidebar = document.getElementById('cart-sidebar');
        const overlay = document.getElementById('cart-overlay');
        const stickyBar = document.getElementById('mobile-sticky-bar');
        
        sidebar.classList.remove('translate-x-0'); 
        sidebar.classList.add('translate-x-full'); 
        overlay.classList.remove('open'); 
        document.body.classList.remove('locked');
        
        if(cart.length === 0) {
            stickyBar.classList.add('hidden'); 
        } else if(window.innerWidth < 1024) {
            stickyBar.classList.remove('translate-y-full');
        }
    }

    function updateCartUI() {
        try { localStorage.setItem('papajose_cart', JSON.stringify(cart)); } catch (e) {}
        
        const totalItems = cart.reduce((acc, item) => acc + item.qty, 0);
        const badge = document.getElementById('cart-badge');
        badge.innerText = totalItems;
        badge.classList.toggle('scale-0', totalItems === 0);

        const list = document.getElementById('cart-items');
        const stickyBar = document.getElementById('mobile-sticky-bar');
        const floatingBtn = document.getElementById('desktop-floating-cart');
        
        if (cart.length === 0) {
            list.innerHTML = `<div class="text-center text-gray-300 mt-20 flex flex-col items-center"><i class="fa fa-shopping-bag text-5xl mb-4 opacity-20"></i><p class="text-sm">Tu carrito est√° vac√≠o</p></div>`;
            stickyBar.classList.add('hidden'); 
            floatingBtn.classList.add('hidden');
            document.getElementById('header-total').classList.remove('opacity-100');
        } else {
            list.innerHTML = cart.map((p) => `
                <div class="flex gap-4 items-center bg-gray-50 p-3 rounded-xl border border-gray-100 hover:border-beige/20 transition-all">
                    <img src="${p.img}" class="w-14 h-14 rounded object-contain bg-white border" alt="${p.nombre}" onerror="this.onerror=null; this.src='${PLACEHOLDER_SVG}'; this.classList.add('img-placeholder')">
                    <div class="flex-1 min-w-0">
                        <h4 class="font-bold text-xs text-gray-800 truncate">${p.nombre}</h4>
                        <p class="text-[10px] text-gray-500 mb-1">SKU: ${p.sku}</p>
                        <p class="text-xs font-black text-gray-900">$${(p.precio * p.qty).toLocaleString()}</p>
                    </div>
                    <div class="flex flex-col items-center bg-white rounded border border-gray-200">
                        <button onclick="cambiarCantidad(${p.id}, 1)" class="w-6 h-6 flex items-center justify-center text-gray-500 hover:text-black text-xs">+</button>
                        <span class="text-xs font-bold">${p.qty}</span>
                        <button onclick="cambiarCantidad(${p.id}, -1)" class="w-6 h-6 flex items-center justify-center text-gray-500 hover:text-red-500 text-xs">-</button>
                    </div>
                </div>
            `).join('');
            
            if(window.innerWidth < 1024) {
                if(document.getElementById('cart-sidebar').classList.contains('translate-x-full')) { 
                    stickyBar.classList.remove('hidden'); 
                    stickyBar.classList.remove('translate-y-full'); 
                }
            }
            if(window.innerWidth >= 1024) {
                floatingBtn.classList.remove('hidden');
            }
        }
        calcularTotal();
    }

    function calcularTotal() {
        let subtotal = cart.reduce((sum, item) => sum + (item.precio * item.qty), 0);
        
        const radios = document.getElementsByName('tipo_envio');
        let tipoEnvio = "rm";
        for(const r of radios) { 
            if(r.checked) tipoEnvio = r.value; 
        }
        
        costoEnvio = (cart.length > 0 && tipoEnvio === 'rm') ? 3500 : 0; 
        totalPagarFinal = subtotal + costoEnvio;
        
        const subtotalFmt = `$${subtotal.toLocaleString()}`;
        document.getElementById('mobile-total-sticky').innerText = subtotalFmt;
        document.getElementById('desktop-floating-total').innerText = subtotalFmt;
        document.getElementById('header-total').innerText = subtotalFmt;
        document.getElementById('cart-total').innerText = `$${totalPagarFinal.toLocaleString()}`;
        
        if(cart.length > 0) {
            document.getElementById('header-total').classList.add('opacity-100'); 
        } else {
            document.getElementById('header-total').classList.remove('opacity-100');
        }
    }

    // --- PROCESAR PEDIDO Y ENVIAR A SUPABASE (con validaci√≥n de perfil y actualizaci√≥n de stock) ---
    async function procesarCheckout() {
        if(cart.length === 0) return;
        
        // Si el cliente no ha iniciado sesi√≥n, le abrimos el modal
        if(!currentUser) {
            mostrarToast("Debes crear una cuenta o iniciar sesi√≥n para pedir", "info");
            openAuthModal();
            return;
        }

        // Asegurar que el perfil est√© cargado
        if (!userProfile) {
            mostrarToast("Cargando tu perfil...", "info");
            await cargarPerfil(currentUser.id);
        }

        // Verificar que el perfil tenga los datos obligatorios
        if (!userProfile || !userProfile.direccion_defecto || !userProfile.rut) {
            mostrarToast("Completa tus datos de env√≠o en Mi Cuenta antes de continuar", "error");
            openAuthModal(); // Para que pueda ver/editar su perfil
            return;
        }

        const btn = document.getElementById('btn-checkout');
        btn.innerHTML = "Procesando... <i class='fa fa-spinner fa-spin'></i>"; 
        btn.disabled = true;

        try {
            let tipoEnvioTexto = "rm";
            for(const r of document.getElementsByName('tipo_envio')) { 
                if(r.checked) tipoEnvioTexto = r.value; 
            }
            
            let tipoDocTexto = "Boleta";
            for(const r of document.getElementsByName('tipo_doc')) { 
                if(r.checked) tipoDocTexto = r.value; 
            }

            // Construir direcci√≥n de env√≠o evitando valores nulos
            const direccion = userProfile.direccion_defecto || '';
            const referencia = userProfile.referencia || '';
            const dirEnvio = direccion + (referencia ? ` | Ref: ${referencia}` : '');

            // 1. Guardar la Orden en Supabase (Tabla orders)
            const { data: order, error: orderError } = await supabaseClient
                .from('orders')
                .insert({
                    user_id: currentUser.id,
                    estado: 'Pendiente de Pago',
                    tipo_envio: tipoEnvioTexto,
                    costo_envio: costoEnvio,
                    tipo_doc: tipoDocTexto,
                    total: totalPagarFinal,
                    direccion_envio: dirEnvio
                })
                .select()
                .single();

            if (orderError) throw orderError;

            // 2. Preparar inserci√≥n de items y actualizaci√≥n de stock
            const itemsToInsert = cart.map(p => ({
                order_id: order.id,
                product_id: p.id,
                cantidad: p.qty,
                precio_historico: p.precio
            }));

            // 3. Verificar stock suficiente para cada producto
            for (const item of cart) {
                const productoDB = db.find(p => p.id === item.id);
                if (!productoDB || productoDB.stock < item.qty) {
                    throw new Error(`Stock insuficiente para ${item.nombre}. Stock disponible: ${productoDB?.stock || 0}`);
                }
            }

            // 4. Insertar items en order_items
            const { error: itemsError } = await supabaseClient
                .from('order_items')
                .insert(itemsToInsert);
                
            if (itemsError) throw itemsError;

            // 5. Restar stock de cada producto
            for (const item of cart) {
                const { error: stockError } = await supabaseClient
                    .from('products')
                    .update({ stock: supabaseClient.rpc('decrement', { x: item.qty }) }) // Asumiendo que tienes una funci√≥n decrement, sino haz update manual
                    .eq('id', item.id);
                
                // Si no tienes funci√≥n decrement, puedes hacer:
                // const producto = db.find(p => p.id === item.id);
                // const nuevoStock = producto.stock - item.qty;
                // const { error: stockError } = await supabaseClient
                //     .from('products')
                //     .update({ stock: nuevoStock })
                //     .eq('id', item.id);
                
                if (stockError) throw stockError;
            }

            // 6. Abrir WhatsApp con el N√∫mero de Pedido y los detalles
            const totalText = document.getElementById('cart-total').innerText;
            const itemsList = cart.map(p => `‚Ä¢ (${p.qty}) ${p.nombre}\n  [SKU: ${p.sku}] - $${(p.precio * p.qty).toLocaleString()}`).join('\n');
            const nombreCliente = userProfile.nombre || "Cliente";
            
            const envioLabel = tipoEnvioTexto === 'rm' ? 'Regi√≥n Metropolitana (+$3.500)' : 'Regiones (Por pagar - Starken)';

            const msg = `*NUEVO PEDIDO #${order.id}* üõí\n\nHola *Papajose SPA*, soy ${nombreCliente}. Confirmo mi pedido:\n\n${itemsList}\n\n*ENV√çO:* ${envioLabel}\n*DOCUMENTO:* ${tipoDocTexto}\n*TOTAL A PAGAR:* ${totalText}\n\nQuedo atento a los datos de transferencia a Cuenta Empresa.`;
            
            const whatsappWindow = window.open(`https://wa.me/${WHATSAPP_NUM}?text=${encodeURIComponent(msg)}`, '_blank');
            
            // Limpiar el carrito despu√©s de enviar
            setTimeout(() => {
                cart = []; 
                localStorage.removeItem('papajose_cart'); 
                updateCartUI(); 
                forceCloseCart(); 
                mostrarToast(`Pedido #${order.id} registrado con √©xito`, "success");
            }, 500); 

            // Si el navegador bloquea la ventana emergente, copiamos al portapapeles
            if (!whatsappWindow || whatsappWindow.closed || typeof whatsappWindow.closed == 'undefined') {
                await navigator.clipboard.writeText(msg);
                mostrarToast("Mensaje copiado. P√©galo en WhatsApp.", "info");
            }

        } catch (error) {
            console.error(error);
            // Si ocurri√≥ un error despu√©s de crear la orden, deber√≠amos eliminarla para mantener consistencia
            // (Esto ser√≠a m√°s elegante con una transacci√≥n)
            mostrarToast("Error al procesar el pedido: " + (error.message || "Intenta nuevamente."), "error");
        } finally {
            btn.innerHTML = `Ir a Pagar <i class="fab fa-whatsapp text-lg"></i>`; 
            btn.disabled = false;
        }
    }

    // --- GENERACI√ìN DE VISTAS HTML ---
    function cardHTML(p) {
        const btnClass = p.disponible ? "bg-gray-900 text-white hover:bg-beige" : "bg-gray-200 text-gray-400 cursor-not-allowed";
        const btnText = p.disponible ? "Agregar" : "Agotado";
        const action = p.disponible ? `addToCart(${p.id})` : "";
        const imageClass = p.disponible ? "" : "no-stock";
        
        return `
            <div class="bg-white rounded-2xl border border-gray-100 hover:border-beige/50 transition-all duration-300 group hover:shadow-lg relative flex flex-col h-full overflow-hidden shadow-sm">
                <div class="relative h-48 md:h-56 bg-white p-2 cursor-pointer" onclick="openProduct(${p.id})">
                    <img src="${p.img}" 
                         class="w-full h-full object-contain group-hover:scale-105 transition duration-500 ${imageClass}" 
                         alt="${p.nombre}"
                         loading="lazy"
                         onerror="this.onerror=null; this.src='${PLACEHOLDER_SVG}'; this.classList.add('img-placeholder')">
                    <span class="absolute bottom-0 left-0 bg-gray-100 px-2 py-1 text-[10px] font-bold text-gray-600 uppercase tracking-wider rounded-tr-lg">${p.cat.substring(0,15)}</span>
                    ${!p.disponible ? '<span class="absolute top-2 right-2 bg-red-500 text-white px-2 py-1 text-[10px] font-bold rounded">AGOTADO</span>' : ''}
                </div>
                <div class="p-4 flex flex-col grow">
                    <h4 class="font-medium text-gray-800 text-sm mb-1 leading-snug line-clamp-2 grow">${p.nombre}</h4>
                    <p class="text-[10px] text-gray-400 font-mono mb-2">SKU: ${p.sku}</p>
                    <div class="flex items-center justify-between mt-auto pt-2 border-t border-gray-50">
                        <span class="font-black text-lg text-gray-900">$${p.precio.toLocaleString()}</span>
                        <button onclick="${action}" class="text-xs font-bold px-3 py-2 rounded-lg transition uppercase ${btnClass}">${btnText}</button>
                    </div>
                </div>
            </div>`;
    }

    function openProduct(id) {
        history.pushState({modal: 'product'}, null, "");
        const p = db.find(x => x.id === id);
        const modal = document.getElementById('product-modal');
        const btnState = p.disponible ? '' : 'disabled class="opacity-50 cursor-not-allowed bg-gray-300"';
        const btnTxt = p.disponible ? 'Agregar al Pedido' : 'Agotado';
        const action = p.disponible ? `addToCart(${p.id}); closeProductModal()` : '';
        
        document.getElementById('modal-content').innerHTML = `
            <div class="flex flex-col h-full relative">
                <div class="flex-1 overflow-y-auto p-6 md:p-8 modal-body-scroll">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 pb-4">
                        <div class="flex items-center justify-center bg-gray-50 rounded-2xl p-4 md:p-8">
                            <img src="${p.img}" class="max-h-72 w-full object-contain ${p.disponible ? '' : 'no-stock'}" alt="${p.nombre}" onerror="this.onerror=null; this.src='${PLACEHOLDER_SVG}'; this.classList.add('img-placeholder')">
                            ${!p.disponible ? '<div class="absolute inset-0 flex items-center justify-center bg-black/10"><span class="bg-red-500 text-white px-4 py-2 font-bold rounded-lg">SIN STOCK</span></div>' : ''}
                        </div>
                        <div class="flex flex-col justify-start">
                            <span class="text-beige font-bold uppercase tracking-widest mb-2 text-xs">${p.cat}</span>
                            <h1 class="text-2xl md:text-3xl font-black text-gray-900 mb-2 leading-tight">${p.nombre}</h1>
                            <p class="text-sm font-mono text-gray-400 mb-4">SKU: ${p.sku}</p>
                            <p class="text-gray-600 leading-relaxed mb-6 font-medium">${p.desc}</p>
                        </div>
                    </div>
                </div>

                <div class="p-4 md:p-6 bg-white border-t border-gray-100 shadow-[0_-5px_20px_rgba(0,0,0,0.05)] z-10 shrink-0">
                    <div class="flex items-center justify-between gap-4">
                        <div class="flex flex-col">
                            <span class="text-[10px] text-gray-400 font-bold uppercase">Precio</span>
                            <span class="text-2xl md:text-3xl font-black text-gray-900">$${p.precio.toLocaleString()}</span>
                        </div>
                        <button onclick="${action}" ${btnState} class="flex-1 md:flex-none md:w-1/2 bg-black text-white py-3 md:py-4 rounded-xl font-bold uppercase tracking-widest hover:bg-beige transition shadow-lg text-sm truncate px-2">
                            ${btnTxt}
                        </button>
                    </div>
                </div>
            </div>`;
        modal.classList.remove('hidden'); 
        document.body.classList.add('locked');
    }

    function closeProductModal() { 
        const modal = document.getElementById('product-modal'); 
        modal.classList.add('hidden'); 
        document.body.classList.remove('locked'); 
        history.back(); 
    }

    function mostrarToast(msg, type = 'success') {
        const t = document.getElementById('toast-modal');
        const c = document.getElementById('toast-content');
        let color = type === 'error' ? 'bg-red-500' : (type === 'info' ? 'bg-blue-500' : 'bg-green-500');
        let icon = type === 'error' ? 'times' : (type === 'info' ? 'info' : 'check');
        
        c.innerHTML = `<div class="w-6 h-6 ${color} rounded-full flex items-center justify-center text-xs text-white"><i class="fa fa-${icon}"></i></div><span class="font-bold text-sm">${msg}</span>`;
        
        t.classList.remove('hidden'); 
        setTimeout(() => t.classList.add('toast-visible'), 10);
        setTimeout(() => { 
            t.classList.remove('toast-visible'); 
            setTimeout(() => t.classList.add('hidden'), 300); 
        }, 2500); // Aumentado a 2.5 segundos para mejor lectura
    }

    function initSwipeGestures() {
        let touchStartX = 0; 
        let touchStartY = 0;
        
        document.addEventListener('touchstart', function(e) { 
            touchStartX = e.changedTouches[0].screenX; 
            touchStartY = e.changedTouches[0].screenY; 
        }, {passive: true});
        
        document.addEventListener('touchend', function(e) {
            const touchEndX = e.changedTouches[0].screenX; 
            const touchEndY = e.changedTouches[0].screenY;
            const diffX = touchStartX - touchEndX; 
            const diffY = Math.abs(touchStartY - touchEndY);
            
            if (diffY < 30 && Math.abs(diffX) > 50) {
                if (diffX > 0 && document.getElementById('cart-sidebar').classList.contains('translate-x-0')) {
                    forceCloseCart();
                }
                else if (diffX < 0 && !document.getElementById('left-sidebar').classList.contains('-translate-x-full')) {
                    handleBackAction();
                }
            }
        }, {passive: true});
    }
</script>
    
</body>
</html>

